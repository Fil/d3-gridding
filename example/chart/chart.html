<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="css/styles.css">
<body>
<script src="crossfilter/crossfilter.js"></script>
<script src="d3.js"></script>
<script src="chart/barChart.js"></script>
<script src="chart/radialChart.js"></script>
<script src="chart/xyChart.js"></script>

<div id="charts">
  <div id="hour-chart" class="chart">
    <div class="title">Hour chart</div>
  </div>
  <div id="delay-chart" class="chart">
    <div class="title">Delay chart</div>
  </div>
  <div id="delay-radial" class="chart">
    <div class="title">Delay radial chart</div>
  </div>
  <div id="xy-radial" class="chart">
    <div class="title">Delay XY chart</div>
  </div>
</div>

<script>

function parseDate(d) {
  return new Date(2001,
      d.substring(0, 2) - 1,
      d.substring(2, 4),
      d.substring(4, 6),
      d.substring(6, 8));
}

// (It's CSV, but GitHub Pages only gzip's JSON at the moment.)
d3.csv("data/flights-3m.json", function(error, data) {

  // Various formatters.
  var formatNumber = d3.format(",d"),
      formatChange = d3.format("+,d"),
      formatDate = d3.time.format("%B %d, %Y"),
      formatTime = d3.time.format("%I:%M %p");

  // A little coercion, since the CSV is untyped.
  data.forEach(function(d, i) {
    d.index = i;
    d.date = parseDate(d.date);
    d.delay = +d.delay;
    d.distance = +d.distance;
  });

  var crossdata = crossfilter(data);
  var all = crossdata.groupAll();

  var hour = crossdata.dimension(function(d) {
    return d.date.getHours() + d.date.getMinutes() / 60;
  });

  var hours = hour.group(Math.floor);

  var delay = crossdata.dimension(function(d) {
    return Math.max(-60, Math.min(149, d.delay));
  });

  var delays = delay.group(function(d) { return Math.floor(d / 10) * 10; });

  var charts = [

    barChart()
        .dimension(hour)
        .group(hours)
      .x(d3.scale.linear()
        .domain([0, 24])
        .rangeRound([0, 10 * 24])),

    barChart()
        .dimension(delay)
        .group(delays)
      .x(d3.scale.linear()
        .domain([-60, 150])
        .rangeRound([0, 10 * 21])),

    radialChart()
        .dimension(delay)
        .group(delays)
      .x(d3.scale.linear()
        .domain([-60, 150])
        .rangeRound([0, 10 * 21])),

    xyChart()
        .dimension(delay)
        .group(delays)
      .x(d3.scale.linear()
        .domain([-60, 150])
        .rangeRound([0, 10 * 21]))

  ];

  var chart = d3.selectAll(".chart")
      .data(charts);

  var chart = d3.selectAll(".chart")
      .data(charts)
      .each(function(chart) {
        chart.on("brush", renderAll).on("brushend", renderAll);
      });


  // Renders the specified chart or list.
  function render(method) {
    d3.select(this).call(method);
  }

  // Whenever the brush moves, re-rendering everything.
  function renderAll() {
    chart.each(render);
    d3.select("#active").text(formatNumber(all.value()));
  }

  window.filter = function(filters) {
    filters.forEach(function(d, i) { charts[i].filter(d); });
    renderAll();
  };

  window.reset = function(i) {
    charts[i].filter(null);
    renderAll();
  };

  renderAll();

});

</script>
